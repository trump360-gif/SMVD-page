# SMVD CMS Code Quality Improvement - Phase 1 PRD

## Project Overview

**Title**: Code Quality Improvement Phase 1 - Modularization & Security Hardening
**Duration**: 1-2 weeks (30-35 hours)
**Target Score**: 4.2/5 ‚Üí 4.5/5
**Start Date**: 2026-02-17
**Context**: Implement 4 critical improvements with no code transformation or loss

## Goals

1. **Modularize Large Files** (8-10 hours)
   - Split 5 files >500 lines into smaller components
   - Maintain 100% backward compatibility
   - Preserve all functionality, logic, data flow

2. **Strengthen XSS Prevention** (4-5 hours)
   - Integrate DOMPurify library
   - Replace basic sanitization with enterprise-grade protection
   - Update 8 components safely

3. **Remove any Types** (2-3 hours)
   - Replace 8 instances of `any` type
   - Maintain type safety throughout
   - Zero TypeScript errors

4. **Optimize Database Queries** (6-8 hours)
   - Fix N+1 query patterns
   - Increase include ratio from 23% to 80%
   - Improve performance without API changes

## Technical Constraints (Must Preserve)

### Code Integrity
- ‚úÖ Zero API endpoint changes
- ‚úÖ Zero database schema changes
- ‚úÖ Zero type definition removals (only expansions)
- ‚úÖ All existing imports/exports must work
- ‚úÖ All existing props/return types must be compatible

### Functional Preservation
- ‚úÖ All 57 pages must build successfully
- ‚úÖ All 52 API endpoints must work identically
- ‚úÖ All user-facing features must be identical
- ‚úÖ All data flows must produce same results

### Build & Deploy Safety
- ‚úÖ TypeScript: 0 errors before and after
- ‚úÖ Build: 57/57 pages before and after
- ‚úÖ No breaking changes to public APIs
- ‚úÖ All migrations reversible

## Phase 1 Task 1: Split Large Files (500+ lines)

### Overview
Identify 5 files >500 lines and split into smaller, maintainable modules

### Subtasks

**Task 1.1: Analyze ProfessorDetailPage (770 lines)**
- Identify component boundaries
- Extract sections: Header, Info, Courses, Biography
- Create type definitions file
- Document data flow before refactoring

**Task 1.2: Split ProfessorDetailPage**
- Create ProfessorHeader.tsx (100-150 lines)
- Create ProfessorInfo.tsx (120-150 lines)
- Create ProfessorCourses.tsx (140-180 lines)
- Create ProfessorBiography.tsx (140-180 lines)
- Update ProfessorDetailPage.tsx (main container, 150-180 lines)
- Verify: All 4 professors render identically
- Verify: No API changes
- Commit: "refactor: Split ProfessorDetailPage into 5 components"

**Task 1.3: Analyze NewsBlogModal (720 lines)**
- Identify form sections, table sections, modal sections
- Extract types: ArticleFormData, BlogModalProps
- Document state management flow

**Task 1.4: Split NewsBlogModal**
- Create ArticleForm.tsx (180-220 lines)
- Create ArticlePreview.tsx (150-180 lines)
- Create BlockEditorPanel.tsx (160-200 lines)
- Update NewsBlogModal.tsx (modal wrapper, 150-180 lines)
- Verify: Form submission works
- Verify: Preview updates in real-time
- Commit: "refactor: Split NewsBlogModal into 4 components"

**Task 1.5: Split WorkDetailPreviewRenderer (707 lines)**
- Extract block renderers: TextBlockPreview, ImageBlockPreview, LayoutRowPreview
- Create renderers directory structure
- Document preview reconciliation logic

**Task 1.6: Implement WorkDetailPreviewRenderer splits**
- Create block-renderers/TextBlockPreview.tsx (100-130 lines)
- Create block-renderers/ImageBlockPreview.tsx (120-150 lines)
- Create block-renderers/LayoutRowPreview.tsx (100-130 lines)
- Create block-renderers/index.ts (re-exports)
- Update WorkDetailPreviewRenderer.tsx (150-180 lines, uses renderers)
- Verify: All preview types render
- Commit: "refactor: Extract WorkDetailPreviewRenderer block types"

**Task 1.7: Analyze WorkDetailPage (613 lines)**
- Identify sections: Header, Metadata, Content, Related
- Extract section components

**Task 1.8: Split WorkDetailPage**
- Create WorkProjectHeader.tsx (100-130 lines)
- Create WorkProjectMetadata.tsx (80-120 lines)
- Create WorkProjectContent.tsx (120-150 lines)
- Update WorkDetailPage.tsx (150-180 lines)
- Verify: All project details display
- Verify: Navigation works
- Commit: "refactor: Split WorkDetailPage into 4 sections"

**Task 1.9: Analyze BlockListRenderer (596 lines)**
- Identify block type renderers
- Extract rendering logic by type

**Task 1.10: Split BlockListRenderer**
- Create block-types/ImageGridRenderer.tsx (90-120 lines)
- Create block-types/TextBlockRenderer.tsx (80-110 lines)
- Create block-types/HeroImageRenderer.tsx (85-115 lines)
- Create block-types/LayoutRowRenderer.tsx (100-130 lines)
- Update BlockListRenderer.tsx (170-200 lines, dispatcher)
- Verify: All block types render identically
- Commit: "refactor: Extract BlockListRenderer type renderers"

**Task 1.11: Run comprehensive tests**
- Build: `npm run build` ‚Üí 57/57 pages
- TypeScript: `npx tsc --noEmit` ‚Üí 0 errors
- Test each page: Visual inspection in dev server
- Test admin: All CMS editors functional
- Verify: No console errors

**Task 1.12: Verify backward compatibility**
- Check: All imports still work from original locations
- Check: All props unchanged
- Check: All return types unchanged
- Document any exports added to index.ts files

### Success Criteria (Task 1)
- ‚úÖ 5 files split into 18 smaller components (average 200-220 lines)
- ‚úÖ Build: 57/57 pages (before: 57/57)
- ‚úÖ TypeScript: 0 errors (before: 0 errors)
- ‚úÖ No broken imports/exports
- ‚úÖ All functionality identical
- ‚úÖ 5 clean commits with clear messages

---

## Phase 1 Task 2: Strengthen XSS Prevention with DOMPurify

### Overview
Replace basic string regex sanitization with enterprise-grade DOMPurify library

### Current State Analysis
- **Location**: src/lib/sanitize.ts (16 lines)
- **Method**: Regex-based script tag removal + event handler removal
- **Coverage**: 8 components (ReactMarkdown wrappers)
- **Limitations**: Basic HTML, no entity encoding, SVG vectors untested

### Subtasks

**Task 2.1: Plan DOMPurify integration**
- Review DOMPurify documentation
- Test with existing content samples
- Document allowed tags/attributes
- Create migration strategy

**Task 2.2: Install and configure DOMPurify**
```bash
npm install isomorphic-dompurify
npm install --save-dev @types/dompurify
```
- Verify installation
- Create config file: src/lib/sanitize-config.ts
- Document allowed HTML tags and attributes

**Task 2.3: Create new sanitize function**
- Location: src/lib/sanitize.ts (replace existing)
- Update: Use DOMPurify.sanitize() with config
- Allowed tags: ['p', 'br', 'strong', 'em', 'u', 'a', 'img', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'ul', 'ol', 'li', 'blockquote', 'code', 'pre']
- Allowed attributes: ['href', 'src', 'alt', 'title', 'class', 'id']
- Config: KEEP_CONTENT: true (preserve text if tags removed)
- Verify: Function signature unchanged (backward compatible)

**Task 2.4: Test sanitization with samples**
- Test: XSS vectors (script tags, event handlers, SVG)
- Test: Valid markdown HTML (headings, lists, links)
- Test: Edge cases (empty strings, null, undefined)
- Document: All test results

**Task 2.5: Update WorkDetailPage.tsx**
- Location: src/components/public/work/WorkDetailPage.tsx
- Change: Wrap ReactMarkdown sanitizeContent() calls
- Count: 2 instances
- Test: All work detail pages render

**Task 2.6: Update NewsEventDetailContent.tsx**
- Location: src/components/public/news/NewsEventDetailContent.tsx
- Change: Update sanitization wrapper
- Count: 1 instance
- Test: News detail pages render

**Task 2.7: Update NewsBlockRenderer.tsx**
- Location: src/components/public/news/NewsBlockRenderer.tsx
- Change: Apply new sanitization
- Count: 1 instance
- Test: Block rendering works

**Task 2.8: Update BlockRenderer.tsx**
- Location: src/components/admin/shared/BlockEditor/BlockRenderer.tsx
- Change: Update sanitization
- Count: 1 instance
- Test: Admin block preview

**Task 2.9: Update TextBlockRenderer.tsx**
- Location: src/components/admin/shared/BlockEditor/renderers/TextBlockRenderer.tsx
- Change: Apply new sanitization
- Count: 1 instance
- Test: Text blocks in admin

**Task 2.10: Update WorkDetailPreviewRenderer.tsx**
- Location: src/components/admin/shared/BlockEditor/renderers/WorkDetailPreviewRenderer.tsx
- Change: Update 3 sanitization calls
- Count: 3 instances
- Test: Work preview modal

**Task 2.11: Update NewsDetailPreviewRenderer.tsx**
- Location: src/components/admin/shared/BlockEditor/renderers/NewsDetailPreviewRenderer.tsx
- Change: Update 2 sanitization calls
- Count: 2 instances
- Test: News preview modal

**Task 2.12: Update MarkdownEditor.tsx**
- Location: src/components/admin/shared/MarkdownEditor.tsx
- Change: Apply new sanitization
- Count: 1 instance
- Test: Markdown editing in CMS

**Task 2.13: Run comprehensive tests**
- Build: `npm run build` ‚Üí 57/57 pages
- TypeScript: `npx tsc --noEmit` ‚Üí 0 errors
- Security test: Attempt XSS injection (browser DevTools)
- Content test: Verify markdown rendering unchanged
- Admin test: All CMS editors work

**Task 2.14: Verify API/type compatibility**
- Check: sanitizeContent() function signature unchanged
- Check: All return types identical
- Check: No breaking changes to components
- Verify: Old code calling sanitize() still works

### Success Criteria (Task 2)
- ‚úÖ DOMPurify installed and configured
- ‚úÖ 8 components updated with new sanitization
- ‚úÖ XSS vectors blocked (verified in browser)
- ‚úÖ All markdown content renders identically
- ‚úÖ Build: 57/57 pages
- ‚úÖ TypeScript: 0 errors
- ‚úÖ 1 clean commit: "security: Strengthen XSS prevention with DOMPurify"

---

## Phase 1 Task 3: Remove any Types (8 instances)

### Overview
Replace all `any` type instances with concrete, type-safe alternatives

### Current any Usage (8 instances)

| # | File | Line | Context | Current | Target |
|---|------|------|---------|---------|--------|
| 1 | home/page.tsx | ~45 | content variable | `any` | `BlogContent` |
| 2 | BlockEditor.tsx | ~120 | DragEvent | `any` | `React.DragEvent<HTMLDivElement>` |
| 3 | BlockEditor.tsx | ~135 | drop handler | `any` | `React.DragEvent<HTMLDivElement>` |
| 4 | BlockEditor.tsx | ~145 | event.dataTransfer | `any` | `DataTransfer \| null` |
| 5 | NewsBlogModal.tsx | ~240 | uploadedAttachments | `any` | `UploadedAttachment[]` |
| 6 | useAboutEditor.ts | ~85 | content state | `any` | `AboutSectionContent` |
| 7 | + 2 more (minor) | various | misc | `any` | various |

### Subtasks

**Task 3.1: Audit all any types**
- Grep: Search entire codebase for " any"
- Categorize: Drag events, content types, misc
- Document: Each usage context

**Task 3.2: Define missing types**
- Create: src/types/events.ts (DragEvent types)
- Create: src/types/content.ts (content types)
- Create: src/types/uploads.ts (upload types)
- Verify: All types export correctly

**Task 3.3: Fix home/page.tsx (Line ~45)**
- Before: `let content: any = {};`
- After: `let content: BlogContent = { blocks: [], metadata: {} };`
- Verify: No TypeScript errors
- Test: Home page renders

**Task 3.4: Fix BlockEditor drag events**
- Create: React.DragEvent types
- Update: Lines ~120, ~135, ~145
- Verify: All drag operations work
- Test: Block dragging in admin

**Task 3.5: Fix NewsBlogModal uploads**
- Define: UploadedAttachment interface
- Update: Line ~240
- Verify: Upload handling works
- Test: News article upload

**Task 3.6: Fix useAboutEditor content**
- Define: AboutSectionContent type
- Update: Line ~85
- Verify: About editor state safe
- Test: About section editing

**Task 3.7: Fix remaining any types**
- Update: All other locations
- Verify: Each context makes sense
- Test: All features work

**Task 3.8: Run comprehensive type check**
- Command: `npx tsc --noEmit`
- Result: Must be 0 errors
- Check: No new errors introduced
- Report: Detailed type check results

**Task 3.9: Verify runtime behavior**
- Build: `npm run build`
- Test: All pages render
- Test: All admin features work
- Compare: Behavior unchanged vs before

### Success Criteria (Task 3)
- ‚úÖ 8 any types removed
- ‚úÖ Concrete types defined for each
- ‚úÖ TypeScript: 0 errors
- ‚úÖ Build: 57/57 pages
- ‚úÖ All runtime behavior identical
- ‚úÖ 1-2 clean commits: "refactor: Remove any types, replace with concrete types"

---

## Phase 1 Task 4: Optimize Database Queries (N+1 removal)

### Overview
Fix N+1 query patterns by increasing Prisma include() usage from 23% to 80%

### Current State
- Total queries: 97
- With include: 22 (23%) ‚Üê **Too low**
- With select: 14 (14%)
- Without optimization: 61 (63%) ‚Üê **N+1 risk**
- Target: 80+ queries with proper includes

### Subtasks

**Task 4.1: Identify all findMany queries**
- Grep: Search for `findMany` in all API routes
- Categorize: Work, News, Curriculum, etc.
- Document: Each with current include status

**Task 4.2: Analyze Work queries**
- File: src/app/api/admin/work/
- Current state: workProject.findMany() without includes
- Required includes: media, sections, images
- Apply: Add include: { media: true, sections: { include: { images: true } } }

**Task 4.3: Analyze News queries**
- File: src/app/api/admin/news/
- Current state: newsArticle.findMany() without includes
- Required includes: media, attachments, author
- Apply: Add appropriate includes

**Task 4.4: Analyze Curriculum queries**
- File: src/app/api/admin/curriculum/
- Current state: course.findMany() without includes
- Required includes: track, module
- Apply: Add includes

**Task 4.5: Analyze Navigation queries**
- File: src/app/api/admin/navigation/
- Current state: navigationItem.findMany()
- Required includes: children (if hierarchical)
- Apply: Add includes

**Task 4.6: Analyze Footer queries**
- File: src/app/api/admin/footer/
- Current state: footer query
- Required includes: socialLinks
- Apply: Add includes

**Task 4.7: Test query performance**
- Enable: Prisma query logging
- Compare: Before vs after query counts
- Measure: Response time improvements
- Document: Performance metrics

**Task 4.8: Verify API responses unchanged**
- Check: All API response shapes identical
- Check: All data still available
- Check: No breaking changes to consumers
- Test: All admin pages work

**Task 4.9: Run comprehensive tests**
- Build: `npm run build` ‚Üí 57/57 pages
- TypeScript: `npx tsc --noEmit` ‚Üí 0 errors
- Test: All admin CMS features
- Monitor: Database query logs

**Task 4.10: Verify no type changes**
- Check: Response types unchanged
- Check: All frontend code still works
- Check: No new type errors
- Commit message: "perf: Optimize database queries with proper includes"

### Success Criteria (Task 4)
- ‚úÖ include() usage: 23% ‚Üí 80%+
- ‚úÖ N+1 patterns eliminated in 60+ queries
- ‚úÖ API response shapes unchanged
- ‚úÖ Build: 57/57 pages
- ‚úÖ TypeScript: 0 errors
- ‚úÖ Performance metrics documented
- ‚úÖ 1 clean commit: "perf: Add Prisma includes to eliminate N+1 queries"

---

## Phase 1 Task 5: Comprehensive Validation & Final Build

### Overview
Final verification before merging to main: all changes preserved, no regressions

### Subtasks

**Task 5.1: TypeScript validation**
- Command: `npx tsc --noEmit`
- Expected: 0 errors
- Document: Any warnings

**Task 5.2: Build validation**
- Command: `npm run build`
- Expected: 57/57 pages
- Document: Build time

**Task 5.3: Dev server verification**
- Start: `npm run dev`
- Test: All public pages (6 pages)
- Test: All admin pages (dashboard, editors)
- Document: Any console errors

**Task 5.4: API endpoint verification**
- Test: All 52 API endpoints
- Check: Response formats unchanged
- Check: No new errors
- Document: API behavior

**Task 5.5: Code inspection**
- Review: All commits in Phase 1
- Verify: No accidental changes
- Check: Comments/documentation clear
- Approve: Code quality acceptable

**Task 5.6: Data integrity verification**
- Test: All CRUD operations still work
- Test: Data consistency
- Test: No data loss
- Document: Data migration complete

**Task 5.7: Security verification**
- Test: XSS attacks blocked (DOMPurify)
- Test: Auth still protects admin
- Test: Input validation still works
- Document: Security improvements

**Task 5.8: Performance verification**
- Measure: Database query improvements
- Measure: Response times
- Compare: Before/after metrics
- Document: Performance gains

**Task 5.9: Git history verification**
- Check: All commits have clear messages
- Check: Each commit is atomic
- Check: Commits in logical order
- Verify: No accidental files committed

**Task 5.10: Create Phase 1 summary**
- Files modified: [count]
- Files created: [count]
- Types added: [count]
- Commits: [count]
- Lines changed: [count]
- Document: In PHASE_1_COMPLETION_REPORT.md

### Success Criteria (Task 5)
- ‚úÖ TypeScript: 0 errors
- ‚úÖ Build: 57/57 pages
- ‚úÖ All APIs working
- ‚úÖ No regressions
- ‚úÖ Security improved
- ‚úÖ Performance improved
- ‚úÖ All commits clean and documented

---

## Context Preservation Strategy

### Problem: Avoid context compression/loss

1. **Task Storage**
   - ‚úÖ Use TaskMaster for all tasks (survives context resets)
   - ‚úÖ Each task has clear acceptance criteria
   - ‚úÖ Each task has verification checklist
   - ‚úÖ All subtasks numbered sequentially

2. **Code Protection**
   - ‚úÖ No breaking changes to APIs
   - ‚úÖ No type deletions (only additions)
   - ‚úÖ All imports/exports compatible
   - ‚úÖ Backward compatible changes

3. **Documentation**
   - ‚úÖ This PRD: Comprehensive overview
   - ‚úÖ CODE_QUALITY_REVIEW_REPORT.md: Detailed analysis
   - ‚úÖ Each commit message: Clear, descriptive
   - ‚úÖ PHASE_1_COMPLETION_REPORT.md: Final summary

4. **Verification Checkpoints**
   - ‚úÖ After each task: Build + TypeScript check
   - ‚úÖ After Phase 1: Comprehensive validation
   - ‚úÖ Git history: All changes tracked
   - ‚úÖ Code review: All changes inspected

---

## Estimated Timeline

- **Task 1** (File splitting): 8-10 hours
  - Subtasks: 1.1-1.12 (12 subtasks)

- **Task 2** (XSS prevention): 4-5 hours
  - Subtasks: 2.1-2.14 (14 subtasks)

- **Task 3** (Remove any types): 2-3 hours
  - Subtasks: 3.1-3.9 (9 subtasks)

- **Task 4** (DB optimization): 6-8 hours
  - Subtasks: 4.1-4.10 (10 subtasks)

- **Task 5** (Final validation): 2-3 hours
  - Subtasks: 5.1-5.10 (10 subtasks)

**Total: 30-35 hours over 1-2 weeks**

---

## Success Metrics

### Before Phase 1
- Overall Score: 4.2/5
- TypeScript: 4.7/5
- Security: 4.0/5
- Performance: 3.8/5

### After Phase 1
- Overall Score: 4.5/5 ‚Üê **+0.3 improvement**
- TypeScript: 5.0/5 ‚Üê **+0.3 improvement**
- Security: 4.5/5 ‚Üê **+0.5 improvement**
- Performance: 4.2/5 ‚Üê **+0.4 improvement**
- Modularity: 4.5/5 ‚Üê **+1.0 improvement**

---

## Risk Mitigation

### Risk 1: Breaking changes to APIs
**Mitigation**: All changes maintain backward compatibility

### Risk 2: Type errors in production
**Mitigation**: Zero TypeScript errors enforced at each step

### Risk 3: Lost context between sessions
**Mitigation**: TaskMaster + detailed PRD + commit messages

### Risk 4: Code transformation/corruption
**Mitigation**: Git history, careful refactoring, extensive testing

### Risk 5: Performance regression
**Mitigation**: Database query optimization, performance testing

---

## Deliverables

1. ‚úÖ **CODE_QUALITY_REVIEW_REPORT.md** (Already created)
2. üìã **PHASE_1_EXECUTION_PLAN.md** (This PRD + expanded)
3. üìä **PHASE_1_COMPLETION_REPORT.md** (Final summary after completion)
4. üìù **Commit history**: 8-10 clean, documented commits
5. üìà **Metrics report**: Before/after comparison
